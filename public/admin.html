<!--   Copyright Andrew Barton andrewbbarton@gmail.com,  2012
       http://www.opensource.org/licenses/MIT, see LICENSE -->

<!DOCTYPE html>
<html>
  <head>
    <title>Web Parrot admin page</title>
     <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
    <script type"text/javascript">
	    var blankLocked = 'Locked: ';
	    var blankIgnored = 'Ignored: ';
	    var blankEtag = 'ETag: ';
	    var blankStatus = 'Status code: ';
	    var blankExpires = 'Expires: ';
	    var blankCheck = 'Time checked: ';
	    var blankRet = 'Time retrieved: ';
	    var url = 'http://' + document.URL.split('/')[2] + '/api';
          
       //update the text shown on the right
       var displayOverview = function(event, ui) {
	       var sele = document.getElementById('requestList').contentWindow.getSelected();
	       //if there are mutliple selected then this function doesn't make sense
	       if(sele.length == 1) {
	          
	          sele = sele[0];
	          document.getElementById('urlLink').href = sele.url;
	          document.getElementById('urlLink').textContent = sele.url;
	          document.getElementById('statusCodeText').textContent = blankStatus + sele.status;
	          document.getElementById('expiresText').textContent = blankExpires + sele.expires;
	          document.getElementById('lockedText').textContent = blankLocked + sele.lock;
	          document.getElementById('ignoredText').textContent = blankIgnored + sele.ignore;
	          document.getElementById('etagText').textContent = blankEtag + sele.etag;
	          var d = new Date(sele.timeRetrieved);
	          document.getElementById('retText').textContent = blankRet + d.getHours() 
             + ':' + d.getMinutes() + ':' + d.getSeconds();
             d = new Date(sele.timeChecked);
	          document.getElementById('checkText').textContent = blankCheck + d.getHours() 
             + ':' + d.getMinutes() + ':' + d.getSeconds();
	       }else {
	          document.getElementById('urlLink').href = '';
	          document.getElementById('urlLink').textContent = '';
	          document.getElementById('statusCodeText').textContent = blankStatus;
	          document.getElementById('expiresText').textContent = blankExpires;
	          document.getElementById('etagText').textContent = blankEtag;
	          document.getElementById('lockedText').textContent = blankLocked;
	          document.getElementById('ignoredText').textContent = blankIgnored;
	          if(sele.length > 1) {
	             var timeRet = new Date(sele[0].timeRetrieved).getTime();
	             var timeCheck = new Date(sele[0].timeChecked).getTime();
	             for(var i = 1; i < sele.length; i++) {
	                if(Math.abs(timeRet - new Date(sele[i].timeRetrieved).getTime()) > 1000) {
	                   timeRet = -1;
	                }
	                if(Math.abs(timeCheck - new Date(sele[i].timeChecked).getTime()) > 1000) {
	                   timeCheck = -1;
	                }
	             }
	             
	             if(timeRet > 0) {
	                timeRet = new Date(sele[0].timeRetrieved);
	                document.getElementById('retText').textContent = blankRet + timeRet.getHours() 
	                    + ':' + timeRet.getMinutes() + ':' + timeRet.getSeconds();
	             }else {
	                document.getElementById('retText').textContent = blankRet;
	             }
	             
	             if(timeCheck > 0) {
	                timeCheck = new Date(sele[0].timeChecked);
	                document.getElementById('checkText').textContent = blankCheck + timeCheck.getHours() 
                        + ':' + timeCheck.getMinutes() + ':' + timeCheck.getSeconds();
	             }else {
	                document.getElementById('checkText').textContent = blankCheck;
	             }
	          }else {
	             document.getElementById('retText').textContent = blankRet;
	             document.getElementById('checkText').textContent = blankCheck;
	          }
	          
	          
	       }
	   };
        
        //on window load bind the function for displaying the overview to the list of selectables in list.
      window.addEventListener('load', function() {
         document.getElementById('requestList').contentWindow.bindMe(displayOverview)
         
         document.getElementById('requestList').contentWindow.bindMe(displayOverview);
         var xmlhttp=new XMLHttpRequest();
         
         xmlhttp.onreadystatechange = function() {
            if(xmlhttp.readyState == 4) {
               if(xmlhttp.responseText == 'opaque') {
                  document.getElementById('modeSelector').selectedIndex = 2;
               }else if (xmlhttp.responseText == 'transparent') {
                  document.getElementById('modeSelector').selectedIndex = 1;
               }else {
                  document.getElementById('modeSelector').selectedIndex = 0;
               }
            }
         }
        
         var getMode = {getMode:'unknown'};
         xmlhttp.open("POST", url, true);
         xmlhttp.setRequestHeader('Content-Type', "application/json");
         xmlhttp.send(JSON.stringify(getMode));
      }, false)
          
	          
	    function displayDetails() {
	       var selected = document.getElementById('requestList').contentWindow.getSelectedIDs();
	       if(selected.length == 1) {
	           var renderMode = document.getElementById('displayType').value
	           if(renderMode == 'responseRender') {
	              var prop = document.getElementById('requestList').contentWindow.getSelected();
	              document.getElementById('preview').src = prop[0].url;
	           }else if(renderMode == 'transcoder') {
	              document.getElementById('preview').src = './transcoder.html?site=' + encodeURIComponent(selected[0]);
	           }else {
	              
	              if(document.getElementById('preview').src.indexOf('parrotPreview.html') == -1) {
	                 document.getElementById('preview').src = './parrotPreview.html';
	              }
	              
	              sendRequestList(renderMode, onDisplayDetail);
	           }
	           
	       }
	    }
    
	    
	    
	    function onModeChange() {
	       var xmlhttp=new XMLHttpRequest();
          var selected = {mode:document.getElementById('modeSelector').value}
          
          xmlhttp.open("POST", url, true);
          xmlhttp.setRequestHeader('Content-Type', "application/json");
          xmlhttp.send(JSON.stringify(selected));
	    }
	    
	    function sendPost(content, onReturn) {
	       var xmlhttp=new XMLHttpRequest();
          xmlhttp.onreadystatechange = function () {
             onReturn(xmlhttp);
          }
         
          xmlhttp.open("POST", url, true);
          xmlhttp.setRequestHeader('Content-Type', "application/json");
          xmlhttp.send(JSON.stringify(content));
	    }
	    
	    function sendRequestList(command, onReturn, manyRequest) {
	       manyRequest = (typeof manyRequest == 'undefined')? false:manyRequest;
	       var selected = Object.create(null);
          selected[command] = document.getElementById('requestList').contentWindow.getSelectedIDs();
          if(manyRequest) {
             for(var i = 0; i < selected[command].length; i++) {
                var sendMe = Object.create(null);
                sendMe[command] = selected[command][i];
                sendPost(sendMe, onReturn);
             }
          }else {
            sendPost(selected, onReturn);
          }
         
	    }
	    /*
	     * All of the functions that can be called on the POST return of sendRequestList
	     */
	    
	    function onCacheReplace(xmlhttp) {
	       if(xmlhttp.readyState == 4) {
             var replaces = jQuery.parseJSON(xmlhttp.responseText);
             document.getElementById('requestList').contentWindow.cacheReplace(replaces);
             displayOverview(null, null);
          }
	    }
	    
	    function onCacheUpdate(xmlhttp) {
          if(xmlhttp.readyState == 4) {
             var updates = jQuery.parseJSON(xmlhttp.responseText);
             document.getElementById('requestList').contentWindow.cacheCheck(updates);
             displayOverview(null, null);
          }
       }
	    
	    function onRemove(xmlhttp) {
          if(xmlhttp.readyState == 4) {
             var removes = jQuery.parseJSON(xmlhttp.responseText);
             document.getElementById('requestList').contentWindow.removeSelectables(removes.removeRequest);
          }
       }
	    
	    function onIgnore(xmlhttp) {
          if(xmlhttp.readyState == 4) {
             var toggles = jQuery.parseJSON(xmlhttp.responseText)['toggleIgnore'];
             var props = document.getElementById('requestList').contentWindow.props;
             for(var j = 0; j < toggles.length; j++) {
                
                var prop = props[toggles[j]];
                //toggle the prop we want by looking at props[url] where url at position j in toggles
                //then get the attribute we want to toggle is ignore
                props[toggles[j]]['ignore'] = !props[toggles[j]]['ignore']
                //cause the overview text to update
                displayOverview(null, null);
             }
             
          }
       }
       
       function onLock(xmlhttp) {
          if(xmlhttp.readyState == 4) {
             var toggles = jQuery.parseJSON(xmlhttp.responseText)['toggleLock'];
             var props = document.getElementById('requestList').contentWindow.props;
             for(var j = 0; j < toggles.length; j++) {
                
                var prop = props[toggles[j]];
                //toggle the prop we want by looking at props[url] where url at position j in toggles
                //then get the attribute we want to toggle is lock
                props[toggles[j]]['lock'] = !props[toggles[j]]['lock']
                //cause the overview text to update
                displayOverview(null, null);
             }
             
          }
       }
       
       function onDisplayDetail(xmlhttp) {
          if(xmlhttp.readyState == 4) {
               var content = xmlhttp.responseText;
               document.getElementById('preview').contentWindow.setContent(content);
          }
       }
       
    </script>
    <style type="text/css">
      html, body {height:95%;}
      p {text-align:left;}
    </style>
  </head>
  <body>
  
  <table width=100% height=100% id=mainTable>
  <tr id="row1">
      <th width=50% height=100% id="column1">
         <button type=button onclick="sendRequestList('cacheCheck', onCacheUpdate, true)">Check Cache</button>
         <button type=button onclick="sendRequestList('cacheReplace', onCacheReplace, true)">Replace Cache</button>
         <iframe src="./reqList" id="requestList" width=100% height=100% scrolling=auto></iframe>
      </th>
      <th height=100%>
         <table>
         <tr>
            <th align="left">
	            <button type=button onclick="sendRequestList('removeRequest', onRemove)">Remove Request</button>
	            <button type=button onclick="sendRequestList('toggleIgnore', onIgnore)">Toggle Ignore</button>
	            <button type=button onclick="sendRequestList('toggleLock', onLock)">Toggle Lock</button>
	            <select id="modeSelector" onchange="onModeChange()">
	              <option id="translucent">Translucent</option>
	              <option id="transparent">Transparent</option>
	              <option id=opaque>Opaque</option>
	            </select>
            </th>
         </tr>
         </table>
               <p id="urlText">URL:<a id=urlLink></a><br></p>
               <p id="statusCodeText">Status code:<br></p>
               <p id="etagText">ETag:<br></p>
               <p id="expiresText">Expires:<br></p>
               <p id="lockedText">Locked:<br></p>
               <p id="ignoredText">Ignored:<br></p>
               <p id="retText">Time retrieved:<br></p>
               <p id="checkText">Time checked:<br></p>
		         <select id="displayType">
		          <option value="responseRender">Response render</option>
		          <option value="responseSource">Response source</option>
		          <option value="requestSource">Request source</option>
		          <option value="transcoder">Set transcoder</option>
		         </select>
		         <button type=button onclick="displayDetails()">Display</button> <br>
               <iframe id=preview width=100% height=55%></iframe>
      </th>
      
      </tr>
  </table>
	
	
  </body>
</html>