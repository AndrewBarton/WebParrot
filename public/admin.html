<!--   Copyright Andrew Barton andrewbbarton@gmail.com,  2012
       http://www.opensource.org/licenses/MIT, see LICENSE -->

<!DOCTYPE html>
<html>
  <head>
    <title>Web Parrot admin page</title>
     <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
    <script type"text/javascript">
	    var url = 'http://' + document.URL.split('/')[2] + '/api';
          
       //update the text shown on the right
       var displayOverview = function(event, ui) {
	       var sele = document.getElementById('requestList').contentWindow.getSelected();
	       //if there are mutliple selected then this function doesn't make sense
	       if(sele.length == 1) {
	          
	          sele = sele[0];
	          document.getElementById('urlLink').href = sele.url;
	          document.getElementById('urlLink').textContent = sele.url;
	          document.getElementById('statusCodeText').textContent = sele.status;
	          document.getElementById('expiresText').textContent = sele.expires;
	          document.getElementById('lockedText').textContent = sele.lock;
	          document.getElementById('ignoredText').textContent = sele.ignore;
	          document.getElementById('etagText').textContent = sele.etag;
	          document.getElementById('newVersionText').textContent = sele.newVer;
	          var d = new Date(sele.timeRetrieved);
	          document.getElementById('retText').textContent = d.getHours() 
             + ':' + d.getMinutes() + ':' + d.getSeconds();
             d = new Date(sele.timeChecked);
	          document.getElementById('checkText').textContent =  + d.getHours() 
             + ':' + d.getMinutes() + ':' + d.getSeconds();
	       }else {
	          document.getElementById('urlLink').href = '';
	          document.getElementById('urlLink').textContent = '';
	          document.getElementById('statusCodeText').textContent = '';
	          document.getElementById('expiresText').textContent = '';
	          document.getElementById('etagText').textContent = '';
	          document.getElementById('lockedText').textContent = '';
	          document.getElementById('ignoredText').textContent = '';
	          if(sele.length > 1) {
	             var timeRet = new Date(sele[0].timeRetrieved).getTime();
	             var timeCheck = new Date(sele[0].timeChecked).getTime();
	             var newVer = true;
	             sele.forEach(function(item) {
	                if(Math.abs(timeRet - new Date(item.timeRetrieved).getTime()) > 1000) {
                      timeRet = -1;
                   }
                   if(Math.abs(timeCheck - new Date(item.timeChecked).getTime()) > 1000) {
                      timeCheck = -1;
                   }
                   newVer &= item.newVer;
	             });
	             
	             document.getElementById('newVersionText'.textContent = newVer);
	             
	             if(timeRet > 0) {
	                timeRet = new Date(sele[0].timeRetrieved);
	                document.getElementById('retText').textContent = timeRet.getHours() 
	                    + ':' + timeRet.getMinutes() + ':' + timeRet.getSeconds();
	             }else {
	                document.getElementById('retText').textContent = '';
	             }
	             
	             if(timeCheck > 0) {
	                timeCheck = new Date(sele[0].timeChecked);
	                document.getElementById('checkText').textContent = timeCheck.getHours() 
                        + ':' + timeCheck.getMinutes() + ':' + timeCheck.getSeconds();
	             }else {
	                document.getElementById('checkText').textContent = '';
	             }
	          }else {
	             document.getElementById('retText').textContent = '';
	             document.getElementById('checkText').textContent = '';
	          }
	          
	          
	       }
	   };
        
        //on window load bind the function for displaying the overview to the list of selectables in list.
      window.addEventListener('load', function() {
         document.getElementById('requestList').contentWindow.bindMe(displayOverview)
         
         document.getElementById('requestList').contentWindow.bindMe(displayOverview);
         var xmlhttp=new XMLHttpRequest();
         
         xmlhttp.onreadystatechange = function() {
            if(xmlhttp.readyState == 4) {
               if(xmlhttp.responseText == 'opaque') {
                  document.getElementById('modeSelector').selectedIndex = 2;
               }else if (xmlhttp.responseText == 'transparent') {
                  document.getElementById('modeSelector').selectedIndex = 1;
               }else {
                  document.getElementById('modeSelector').selectedIndex = 0;
               }
            }
         }
        
         var getMode = {getMode:'unknown'};
         xmlhttp.open("POST", url, true);
         xmlhttp.setRequestHeader('Content-Type', "application/json");
         xmlhttp.send(JSON.stringify(getMode));
      }, false)
          
	          
	    function displayDetails() {
	       var selected = document.getElementById('requestList').contentWindow.getSelectedIDs();
	       if(selected.length == 1) {
	           var renderMode = document.getElementById('displayType').value
	           if(renderMode == 'responseRender') {
	              var prop = document.getElementById('requestList').contentWindow.getSelected();
	              document.getElementById('preview').src = prop[0].url;
	           }else if(renderMode == 'transcoder') {
	              document.getElementById('preview').src = './transcoder.html?site=' + encodeURIComponent(selected[0]);
	           }else {
	              
	              if(document.getElementById('preview').src.indexOf('parrotPreview.html') == -1) {
	                 document.getElementById('preview').src = './parrotPreview.html';
	              }
	              
	              sendRequestList(renderMode, onDisplayDetail);
	           }
	           
	       }
	    }
    
	    
	    
	    function onModeChange() {
	       var xmlhttp=new XMLHttpRequest();
          var selected = {mode:document.getElementById('modeSelector').value}
          
          xmlhttp.open("POST", url, true);
          xmlhttp.setRequestHeader('Content-Type', "application/json");
          xmlhttp.send(JSON.stringify(selected));
	    }
	    
	    function sendPost(content, onReturn) {
	       var xmlhttp=new XMLHttpRequest();
          xmlhttp.onreadystatechange = function () {
             onReturn(xmlhttp);
          }
         
          xmlhttp.open("POST", url, true);
          xmlhttp.setRequestHeader('Content-Type', "application/json");
          xmlhttp.send(JSON.stringify(content));
	    }
	    
	    function sendRequestList(command, onReturn, manyRequest) {
	       manyRequest = (typeof manyRequest == 'undefined')? false:manyRequest;
	       var selected = Object.create(null);
          selected[command] = document.getElementById('requestList').contentWindow.getSelectedIDs();
          if(manyRequest) {
             for(var i = 0; i < selected[command].length; i++) {
                var sendMe = Object.create(null);
                sendMe[command] = selected[command][i];
                sendPost(sendMe, onReturn);
             }
          }else {
            sendPost(selected, onReturn);
          }
         
	    }
	    /*
	     * All of the functions that can be called on the POST return of sendRequestList
	     */
	    
	    function onCacheReplace(xmlhttp) {
	       if(xmlhttp.readyState == 4) {
             var replaces = jQuery.parseJSON(xmlhttp.responseText);
             document.getElementById('requestList').contentWindow.cacheReplace(replaces);
             displayOverview(null, null);
          }
	    }
	    
	    function onCacheUpdate(xmlhttp) {
          if(xmlhttp.readyState == 4) {
             var updates = jQuery.parseJSON(xmlhttp.responseText);
             document.getElementById('requestList').contentWindow.cacheCheck(updates);
             displayOverview(null, null);
          }
       }
	    
	    function onRemove(xmlhttp) {
          if(xmlhttp.readyState == 4) {
             var removes = jQuery.parseJSON(xmlhttp.responseText);
             document.getElementById('requestList').contentWindow.removeSelectables(removes.removeRequest);
          }
       }
	    
	    function onIgnore(xmlhttp) {
          if(xmlhttp.readyState == 4) {
             var toggles = jQuery.parseJSON(xmlhttp.responseText)['toggleIgnore'];
             var props = document.getElementById('requestList').contentWindow.props;
             for(var j = 0; j < toggles.length; j++) {
                
                var prop = props[toggles[j]];
                //toggle the prop we want by looking at props[url] where url at position j in toggles
                //then get the attribute we want to toggle is ignore
                props[toggles[j]]['ignore'] = !props[toggles[j]]['ignore']
                //cause the overview text to update
                displayOverview(null, null);
             }
             
          }
       }
       
       function onLock(xmlhttp) {
          if(xmlhttp.readyState == 4) {
             var toggles = jQuery.parseJSON(xmlhttp.responseText)['toggleLock'];
             var props = document.getElementById('requestList').contentWindow.props;
             for(var j = 0; j < toggles.length; j++) {
                
                var prop = props[toggles[j]];
                //toggle the prop we want by looking at props[url] where url at position j in toggles
                //then get the attribute we want to toggle is lock
                props[toggles[j]]['lock'] = !props[toggles[j]]['lock']
                //cause the overview text to update
                displayOverview(null, null);
             }
             
          }
       }
       
       function onDisplayDetail(xmlhttp) {
          if(xmlhttp.readyState == 4) {
               var content = xmlhttp.responseText;
               if(document.getElementById('preview').contentWindow.setContent) {
                  document.getElementById('preview').contentWindow.setContent(content);
               }else {
                  document.getElementById('preview').onload = function() {
                     document.getElementById('preview').contentWindow.setContent(content);
                     };
                }
               
          }
       }
       
    </script>
    <style type="text/css">
      html, body {height:95%;}
      span {float:left; margin:0;}
      a {float: left;}
    </style>
  </head>
  <body>
  
  <table width=100% height=100% id=mainTable>
  <tr id="row1">
      <th width=50% height=100% id="column1">
         <button type=button onclick="sendRequestList('cacheCheck', onCacheUpdate, true)">Check Cache</button>
         <button type=button onclick="sendRequestList('cacheReplace', onCacheReplace, true)">Replace Cache</button>
         <iframe src="./reqList" id="requestList" width=100% height=100% scrolling=auto></iframe>
      </th>
      <th height=100%>
         <table>
         <tr>
            <th align="left">
	            <button type=button onclick="sendRequestList('removeRequest', onRemove)">Remove Request</button>
	            <button type=button onclick="sendRequestList('toggleIgnore', onIgnore)">Toggle Ignore</button>
	            <button type=button onclick="sendRequestList('toggleLock', onLock)">Toggle Lock</button>
	            <select id="modeSelector" onchange="onModeChange()">
	              <option id="translucent">Translucent</option>
	              <option id="transparent">Transparent</option>
	              <option id=opaque>Opaque</option>
	            </select>
            </th>
         </tr>
         </table>
               <span>URL:</span><a id=urlLink></a><br>
               <span>Status code:</span><span id="statusCodeText"></span><br>
               <span>ETag:</span><span id="etagText"></span><br>
               <span>Expires:</span><span id="expiresText"></span><br>
               <span>Locked:</span><span id="lockedText"></span><br>
               <span>Ignored:</span><span id="ignoredText"></span><br>
               <span>Time retrieved:</span><span id="retText"></span><br>
               <span>Time checked:</span><span id="checkText"></span><br>
               <span>New version:</span><span id="newVersionText"></span><br>
		         <select id="displayType">
		          <option value="responseRender">Response render</option>
		          <option value="responseSource">Response source</option>
		          <option value="requestSource">Request source</option>
		          <option value="transcoder">Set transcoder</option>
		         </select>
		         <button type=button onclick="displayDetails()">Display</button> <br>
               <iframe id=preview width=100% height=70%></iframe>
      </th>
      
      </tr>
  </table>
	
	
  </body>
</html>